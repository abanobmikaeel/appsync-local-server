<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuration - appsync-local</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav>
    <div class="nav-container">
      <a href="index.html" class="logo">appsync-local</a>
      <div class="nav-links">
        <a href="getting-started.html">Getting Started</a>
        <a href="configuration.html">Configuration</a>
        <a href="data-sources.html">Data Sources</a>
        <a href="https://github.com/abanobmikaeel/appsync-local" target="_blank">GitHub</a>
      </div>
    </div>
  </nav>

  <main>
    <div class="doc-content">
      <h1>Configuration Reference</h1>

      <h2>Configuration File</h2>
      <p>The configuration file (default: <code>appsync-config.json</code>) defines your GraphQL API:</p>

      <table>
        <tr><th>Property</th><th>Type</th><th>Required</th><th>Description</th></tr>
        <tr><td><code>schema</code></td><td>string | string[]</td><td>Yes</td><td>Path to GraphQL schema file(s)</td></tr>
        <tr><td><code>port</code></td><td>number</td><td>No</td><td>Server port (default: 4000)</td></tr>
        <tr><td><code>apiConfig</code></td><td>object</td><td>No</td><td>API configuration including auth</td></tr>
        <tr><td><code>dataSources</code></td><td>array</td><td>Yes</td><td>Data source definitions</td></tr>
        <tr><td><code>resolvers</code></td><td>array</td><td>Yes</td><td>Resolver mappings</td></tr>
      </table>

      <h2>Authentication</h2>
      <p>Configure authentication in <code>apiConfig.auth</code>:</p>

      <h3>API Key</h3>
      <pre><code>{
  "type": "API_KEY",
  "key": "da2-your-api-key",
  "expiration": 1735689600000  // Optional: Unix timestamp
}</code></pre>

      <h3>AWS Lambda Authorizer</h3>
      <pre><code>{
  "type": "AWS_LAMBDA",
  "lambdaFunction": "auth/authorizer.js"
}</code></pre>

      <h3>Cognito User Pools</h3>
      <pre><code>{
  "type": "AMAZON_COGNITO_USER_POOLS"
}</code></pre>

      <h3>OpenID Connect</h3>
      <pre><code>{
  "type": "OPENID_CONNECT"
}</code></pre>

      <h3>IAM</h3>
      <pre><code>{
  "type": "AWS_IAM"
}</code></pre>

      <h2>Resolver Configuration</h2>
      <p>Each resolver maps a GraphQL field to a data source:</p>

      <h3>Unit Resolver</h3>
      <pre><code>{
  "type": "Query",
  "field": "getUser",
  "kind": "Unit",
  "dataSource": "UsersTable",
  "file": "resolvers/getUser.js"
}</code></pre>

      <h3>Pipeline Resolver</h3>
      <pre><code>{
  "type": "Mutation",
  "field": "createOrder",
  "kind": "Pipeline",
  "file": "resolvers/createOrder.js",
  "pipelineFunctions": [
    {
      "dataSource": "UsersTable",
      "file": "functions/validateUser.js"
    },
    {
      "dataSource": "OrdersTable",
      "file": "functions/createOrder.js"
    }
  ]
}</code></pre>

      <h2>Schema Directives</h2>
      <p>appsync-local fully supports AWS AppSync authorization directives for field-level access control.</p>

      <h3>Authorization Directives</h3>
      <p>Control which auth modes can access types and fields:</p>

      <table>
        <tr><th>Directive</th><th>Description</th></tr>
        <tr><td><code>@aws_api_key</code></td><td>Allow API key authentication</td></tr>
        <tr><td><code>@aws_iam</code></td><td>Allow IAM authentication</td></tr>
        <tr><td><code>@aws_cognito_user_pools</code></td><td>Allow Cognito User Pools authentication</td></tr>
        <tr><td><code>@aws_oidc</code></td><td>Allow OpenID Connect authentication</td></tr>
        <tr><td><code>@aws_lambda</code></td><td>Allow Lambda authorizer authentication</td></tr>
      </table>

      <h3>Type-Level Authorization</h3>
      <p>Apply directives to entire types - all fields inherit the auth requirements:</p>
      <pre><code>type Query @aws_api_key @aws_cognito_user_pools {
  getPublicData: String    # Both API key and Cognito can access
  listItems: [Item]        # Both API key and Cognito can access
}</code></pre>

      <h3>Field-Level Authorization</h3>
      <p>Override type-level directives for specific fields:</p>
      <pre><code>type Query @aws_api_key {
  publicData: String           # Inherits @aws_api_key from type
  adminData: String @aws_iam   # Only IAM users can access
}</code></pre>

      <h3>Cognito Group Restrictions</h3>
      <p>Restrict access to specific Cognito groups:</p>
      <pre><code>type Mutation {
  updateUser: User @aws_cognito_user_pools
  deleteUser: User @aws_cognito_user_pools(cognito_groups: ["Admin"])
}</code></pre>

      <h3>Subscription Directives</h3>
      <p>Link subscriptions to mutations using <code>@aws_subscribe</code>:</p>
      <pre><code>type Subscription {
  onPostCreated: Post @aws_subscribe(mutations: ["createPost"])
  onPostUpdated: Post @aws_subscribe(mutations: ["updatePost", "editPost"])
}</code></pre>

      <h3>Lambda Authorizer Dynamic Denial</h3>
      <p>Lambda authorizers can dynamically deny specific fields by returning <code>deniedFields</code>:</p>
      <pre><code>// auth/authorizer.js
export async function handler(event) {
  const user = validateToken(event.authorizationToken);

  return {
    isAuthorized: true,
    deniedFields: user.role === 'basic'
      ? ['Query.premiumContent', 'Mutation.adminAction']
      : [],
    resolverContext: { userId: user.id, role: user.role }
  };
}</code></pre>

      <h2>CLI Options</h2>
      <pre><code>appsync-local start [options]

Options:
  -c, --config &lt;path&gt;   Config file path (default: appsync-config.json)
  -p, --port &lt;number&gt;   Server port (overrides config)
  -h, --help            Show help</code></pre>

      <h2>Environment Variables</h2>
      <table>
        <tr><th>Variable</th><th>Description</th></tr>
        <tr><td><code>PORT</code></td><td>Server port (if not specified in config or CLI)</td></tr>
        <tr><td><code>APPSYNC_LOCAL_SSL_REJECT_UNAUTHORIZED</code></td><td>Set to "false" to allow self-signed SSL certs for RDS</td></tr>
      </table>
    </div>
  </main>

  <footer>
    <p>MIT License - <a href="https://github.com/abanobmikaeel/appsync-local">GitHub</a></p>
  </footer>
</body>
</html>
